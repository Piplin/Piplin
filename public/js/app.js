function Uploader(t){if(!(this instanceof Uploader))return new Uploader(t);isString(t)&&(t={trigger:t});var e={trigger:null,name:null,action:null,data:null,accept:null,change:null,error:null,multiple:!0,success:null};t&&$.extend(e,t);var n=$(e.trigger);e.action=e.action||n.data("action")||"/upload",e.name=e.name||n.attr("name")||n.data("name")||"file",e.data=e.data||parse(n.data("data")),e.accept=e.accept||n.data("accept"),e.success=e.success||n.data("success"),this.settings=e,this.setup(),this.bind()}function isString(t){return"[object String]"===Object.prototype.toString.call(t)}function createInputs(t){if(!t)return[];var e,n=[];for(var o in t)e=document.createElement("input"),e.type="hidden",e.name=o,e.value=t[o],n.push(e);return n}function parse(t){if(!t)return{};for(var e={},n=t.split("&"),o=function(t){return decodeURIComponent(t.replace(/\+/g," "))},i=0;i<n.length;i++){var r=n[i].split("="),s=o(r[0]),a=o(r[1]);e[s]=a}return e}function findzIndex(t){for(var e=t.parentsUntil("body"),n=0,o=0;o<e.length;o++){var i=e.eq(o);"static"!==i.css("position")&&(n=parseInt(i.css("zIndex"),10)||n)}return n}function newIframe(){var t="iframe-uploader-"+iframeCount,e=$('<iframe name="'+t+'" />').hide();return iframeCount+=1,e}function MultipleUploader(t){if(!(this instanceof MultipleUploader))return new MultipleUploader(t);isString(t)&&(t={trigger:t});var e=$(t.trigger),n=[];e.each(function(e,o){t.trigger=o,n.push(new Uploader(t))}),this._uploaders=n}!function(t){function e(){t.ajax({type:"GET",url:"/timeline"}).success(function(e){t("#timeline").html(e)})}function n(e){e.model.time=moment(e.model.started_at).fromNow(),e.model.url="/deployment/"+e.model.id,t("#deployment_info_"+e.model.id).remove();var n=_.template(t("#deployment-list-template").html()),o=n(e.model);e.model.status===i?t(".pending_menu").append(o):e.model.status===r?t(".deploying_menu").append(o):e.model.status!==s&&e.model.status!==a||t(".approving_menu").append(o);var l=t(".pending_menu li.todo_item").length,p=t(".deploying_menu li.todo_item").length,d=t(".approving_menu li.todo_item").length,u=l+p+d;u>0?(t("#todo_menu span.label").html(u).addClass("label-success"),t("#todo_menu .dropdown-toggle i.ion").addClass("text-danger")):(t("#todo_menu span.label").html("").removeClass("label-success"),t("#todo_menu .dropdown-toggle i.ion").removeClass("text-danger"));var c=_.template(t("#todo-item-empty-template").html());l>0?(t(".pending_header i").addClass("fixhub-spin"),t(".pending_menu li.item_empty").remove()):(t(".pending_header i").removeClass("fixhub-spin"),t(".pending_menu li.item_empty").remove(),t(".pending_menu").append(c({empty_text:trans("dashboard.pending_empty")}))),p>0?(t(".deploying_header i").addClass("fixhub-spin"),t(".deploying_menu li.item_empty").remove()):(t(".deploying_header i").removeClass("fixhub-spin"),t(".deploying_menu li.item_empty").remove(),t(".deploying_menu").append(c({empty_text:trans("dashboard.running_empty")}))),d>0?(t(".approving_header i").addClass("fixhub-spin"),t(".approving_menu li.item_empty").remove()):(t(".approving_header i").removeClass("fixhub-spin"),t(".approving_menu li.item_empty").remove(),t(".approving_menu").append(c({empty_text:trans("dashboard.approving_empty")})));var m=Lang.choice("dashboard.pending",l,{count:l}),h=Lang.choice("dashboard.running",p,{count:p}),f=Lang.choice("dashboard.approving",d,{count:d});t(".deploying_header span").text(h),t(".pending_header span").text(m),t(".approving_header span").text(f)}if(t.ajaxPrefilter(function(e,n,o){o.setRequestHeader("X-CSRF-Token",t('meta[name="token"]').attr("content"))}),t("form").submit(function(){t(this).find(":submit").prop("disabled",!0)}),null==window.location.href.match(/login|password/)){var o=t('meta[name="locale"]').attr("content");Lang.setLocale(o),moment.locale(o),t("abbr.timeago").each(function(){var e=t(this);e.livestamp(e.data("timeago")).tooltip()}),t('[data-toggle="tooltip"]').tooltip(),t(".select2").select2({width:"100%",minimumResultsForSearch:1/0}),toastr.options.closeButton=!0,toastr.options.progressBar=!0,toastr.options.preventDuplicates=!0,toastr.options.closeMethod="fadeOut",toastr.options.closeDuration=3e3,toastr.options.closeEasing="swing",toastr.options.positionClass="toast-bottom-right",toastr.options.timeOut=5e3,toastr.options.extendedTimeOut=7e3;var i=1,r=2,s=7,a=8;window.Fixhub={},Fixhub.project_id=Fixhub.project_id||null,Fixhub.listener=io.connect(t('meta[name="socket_url"]').attr("content"),{query:"jwt="+t('meta[name="jwt"]').attr("content")}),Fixhub.connection_error=!1,Fixhub.listener.on("connect_error",function(e){Fixhub.connection_error||t("#socket_offline").show(),Fixhub.connection_error=!0}),Fixhub.listener.on("connect",function(){t("#socket_offline").hide(),Fixhub.connection_error=!1}),Fixhub.listener.on("reconnect",function(){t("#socket_offline").hide(),Fixhub.connection_error=!1}),Fixhub.listener.on("deployment:Fixhub\\Bus\\Events\\ModelChangedEvent",function(o){n(o),t("#timeline").length>0&&e();var i=t("#deployment_"+o.model.id);if(i.length>0){t("td:nth-child(6)",i).text(o.model.committer),o.model.commit_url?t("td:nth-child(7)",i).html('<a href="'+o.model.commit_url+'" target="_blank">'+o.model.short_commit+"</a>"):t("td:nth-child(8)",i).text(o.model.short_commit);var s="clock-o",a="info",l=trans("deployments.pending"),p=!1,d=!1;o.model.status=parseInt(o.model.status);var u=t("td:nth-child(9) span.label",i);0===o.model.status?(s="checkmark-round",a="success",l=trans("deployments.completed"),p=!0,d=!0):o.model.status===r?(s="load-c fixhub-spin",a="warning",l=trans("deployments.running")):3===o.model.status?(s="close-round",a="danger",l=trans("deployments.failed"),p=!0):4===o.model.status?(s="close",a="success",l=trans("deployments.completed_with_errors"),p=!0,d=!0):5===o.model.status&&(s="alert",a="danger",l=trans("deployments.cancelled"),p=!0),p&&(t("button#deploy_project:disabled").removeAttr("disabled"),t("td:nth-child(10) a.btn-cancel",i).remove(),d&&t("button.btn-rollback").removeClass("hide")),u.attr("class","label label-"+a),t("i",u).attr("class","ion ion-"+s),t("span",u).text(l)}else{var c=trans("dashboard.deployment_number",{id:o.model.id});0===o.model.status?toastr.success(c+" - "+trans("deployments.completed"),o.model.project_name):3===o.model.status?toastr.error(c+" - "+trans("deployments.failed"),o.model.project_name):4===o.model.status&&toastr.warning(c+" - "+trans("deployments.completed_with_errors"),o.model.project_name)}}),Fixhub.listener.on("project:Fixhub\\Bus\\Events\\ModelChangedEvent",function(e){var n=t("#project_"+e.model.id);if(n.length>0){var o="question-circle",i="primary",r=trans("projects.not_deployed");e.model.status=parseInt(e.model.status);var s=t("td:nth-child(4) span.label",n);0===e.model.status?(o="checkmark-round",i="success",r=trans("projects.finished")):2===e.model.status?(o="load-c fixhub-spin",i="warning",r=trans("projects.deploying")):3===e.model.status?(o="close-round",i="danger",r=trans("projects.failed")):1===e.model.status&&(o="clock",i="info",r=trans("projects.pending")),t("td:first a",n).text(e.model.name),t("td:nth-child(3)",n).text(moment(e.model.last_run).fromNow()),s.attr("class","label label-"+i),t("i",s).attr("class","ion ion-"+o),t("span",s).text(r)}}),Fixhub.listener.on("project:Fixhub\\Bus\\Events\\ModelTrashedEvent",function(t){parseInt(t.model.id)===parseInt(Fixhub.project_id)&&(window.location.href="/")})}}(jQuery);var iframeCount=0;Uploader.prototype.setup=function(){this.form=$('<form method="post" enctype="multipart/form-data"target="" action="'+this.settings.action+'" />'),this.iframe=newIframe(),this.form.attr("target",this.iframe.attr("name"));var t=this.settings.data;this.form.append(createInputs(t)),window.FormData?this.form.append(createInputs({_uploader_:"formdata"})):this.form.append(createInputs({_uploader_:"iframe"}));var e=document.createElement("input");e.type="file",e.name=this.settings.name,this.settings.accept&&(e.accept=this.settings.accept),this.settings.multiple&&(e.multiple=!0,e.setAttribute("multiple","multiple")),this.input=$(e);var n=$(this.settings.trigger);return this.input.attr("hidefocus",!0).css({position:"absolute",top:0,right:0,opacity:0,outline:0,cursor:"pointer",height:n.outerHeight(),fontSize:Math.max(64,5*n.outerHeight())}),this.form.append(this.input),this.form.css({position:"absolute",top:n.offset().top,left:n.offset().left,overflow:"hidden",width:n.outerWidth(),height:n.outerHeight(),zIndex:findzIndex(n)+10}).appendTo("body"),this},Uploader.prototype.bind=function(){var t=this,e=$(t.settings.trigger);e.mouseenter(function(){t.form.css({top:e.offset().top,left:e.offset().left,width:e.outerWidth(),height:e.outerHeight()})}),t.bindInput()},Uploader.prototype.bindInput=function(){var t=this;t.input.change(function(e){t._files=this.files||[{name:e.target.value}];var n=t.input.val();if(t.settings.change)t.settings.change.call(t,t._files);else if(n)return t.submit()})},Uploader.prototype.submit=function(){var t=this;if(window.FormData&&t._files){var e=new FormData(t.form.get(0));e.append(t.settings.name,t._files);var n;if(t.settings.progress){var o=t._files;n=function(){var e=$.ajaxSettings.xhr();return e.upload&&e.upload.addEventListener("progress",function(e){var n=0,i=e.loaded||e.position,r=e.total;e.lengthComputable&&(n=Math.ceil(i/r*100)),t.settings.progress(e,i,r,n,o)},!1),e}}return $.ajax({url:t.settings.action,type:"post",processData:!1,contentType:!1,data:e,xhr:n,context:this,success:t.settings.success,error:t.settings.error}),this}return t.iframe=newIframe(),t.form.attr("target",t.iframe.attr("name")),$("body").append(t.iframe),t.iframe.one("load",function(){$('<iframe src="javascript:false;"></iframe>').appendTo(t.form).remove();var e;try{e=$(this).contents().find("body").html()}catch(t){e="cross-domain"}$(this).remove(),e?t.settings.success&&t.settings.success(e):t.settings.error&&t.settings.error(t.input.val())}),t.form.submit(),this},Uploader.prototype.refreshInput=function(){var t=this.input.clone();this.input.before(t),this.input.off("change"),this.input.remove(),this.input=t,this.bindInput()},Uploader.prototype.change=function(t){return t?(this.settings.change=t,this):this},Uploader.prototype.success=function(t){var e=this;return this.settings.success=function(n){e.refreshInput(),t&&t(n)},this},Uploader.prototype.error=function(t){var e=this;return this.settings.error=function(n){t&&(e.refreshInput(),t(n))},this},Uploader.prototype.enable=function(){this.input.prop("disabled",!1),this.input.css("cursor","pointer")},Uploader.prototype.disable=function(){this.input.prop("disabled",!0),this.input.css("cursor","not-allowed")},MultipleUploader.prototype.submit=function(){return $.each(this._uploaders,function(t,e){e.submit()}),this},MultipleUploader.prototype.change=function(t){return $.each(this._uploaders,function(e,n){n.change(t)}),this},MultipleUploader.prototype.success=function(t){return $.each(this._uploaders,function(e,n){n.success(t)}),this},MultipleUploader.prototype.error=function(t){return $.each(this._uploaders,function(e,n){n.error(t)}),this},MultipleUploader.prototype.enable=function(){return $.each(this._uploaders,function(t,e){e.enable()}),this},MultipleUploader.prototype.disable=function(){return $.each(this._uploaders,function(t,e){e.disable()}),this},MultipleUploader.Uploader=Uploader;